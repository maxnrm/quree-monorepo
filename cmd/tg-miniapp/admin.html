<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan QR</title>
</head>

<body>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        let tg = window.Telegram.WebApp; //получаем объект webapp телеграма 
        let lastScannedChatID = 0

        tg.showScanQrPopup({ text: "Сканирование..." }, function () {
            return false
        });

        tg.onEvent("qrTextReceived", async function({ data }) {

            let sendObject = {}
            sendObject.user_chat_id = data.split(",")[0]
            sendObject.qr_code_id = data.split(",")[1]

            if  (lastScannedChatID == sendObject.user_chat_id) {
                return
            }

            result = await fetch("/api/user_event_visit/create", {
                method: "POST",
                body: JSON.stringify(sendObject)
            })

            if (result.ok) {
                lastScannedChatID = sendObject.user_chat_id
            }
        })

        tg.onEvent("scan_qr_popup_closed", async function() {
            tg.close()
        })

        tg.ready();
    </script>
</body>

</html>